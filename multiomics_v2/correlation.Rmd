---
title: "Proteomic data + miRNA. Correlation"
output:
  html_document:
    toc: yes
    toc_float: yes
    theme: cerulean
    highlight: kate
    code_folding: hide
  always_allow_html: true  
  pdf_document:
    toc: yes
editor_options:
  chunk_output_type: console
---

# miRNA selected

  *   miRNA 210-3p
  *   miRNA 320a
  *   miRNA 320b
  *   miRNA 320c
  *   miRNA 4745-5p

# Proteins

Proteins DE.

```{r,echo=F}
knitr::opts_chunk$set(echo = TRUE,warning = F,message = F,fig.height=10, fig.width=10)
library(DT)
```

```{r}
load(file = "data_mirna_int")
load(file = "./matriu_unificada")
RNA_tab_sig<-get(load(file="RNA_tab_sig"))
RNA_tab<-get(load(file="RNA_tab"))
# dim(datExpr0)
matriu<-t(datExpr0)
matriu<-log2(matriu)

datatable_jm<-function(x,column=NULL){
  
  # if(is.na(column)){column<-0}

datatable(
  x,
  extensions = 'Buttons', 
  filter = list(
    position = 'top', clear = T
  ),
  options = list(dom = 'Blfrtip',buttons = list(list(extend = 'colvis')),
                 buttons = list('copy', 'print',
                                list(extend = 'collection',
                                     buttons = c('csv', 'excel', 'pdf'),
                                     text = 'Download')),
                 columnDefs = list(list(visible=FALSE, targets=column))))}


```


# Correaltion

Only proteins with significative correlation between miRNA and protein expression.

```{r}
# CorrelaciÃ³

matriu_corr<-matrix(data=NA,nrow = dim(matriu)[1],ncol = length(rownames(data_mirna_int)),dimnames = list(rownames(matriu),rownames(data_mirna_int)))
matriu_corr_p<-matrix(data=NA,nrow = dim(matriu)[1],ncol = length(rownames(data_mirna_int)),dimnames = list(rownames(matriu),rownames(data_mirna_int)))
for(j in 1 :dim(matriu_corr_p)[2]){
for(i in 1:dim(matriu_corr_p)[1]){
corr_mirna_prot<-cor.test(data_mirna_int[j,],matriu[i,])
corr_mirna_prot$p.value
matriu_corr[i,j]<-corr_mirna_prot$estimate
matriu_corr_p[i,j]<-corr_mirna_prot$p.value
}

}
library(ComplexHeatmap)
matriu_corr_sig<-matriu_corr*(matriu_corr_p<=0.05)
matriu_filter<-matrix((apply(matriu_corr_sig, 1, function (x) sum(x!=0)>0))
                      ,dim(matriu_corr_sig)[1],1,dimnames = list(rownames(matriu_corr_sig),"boolean"))

matriu_corr_sig<-(matriu_corr_sig[matriu_filter,])
# Identificar proteines diferencialment expressades
matriu_corr_sig<-matriu_corr_sig[rownames(matriu_corr_sig)%in%rownames(RNA_tab_sig),]

matriu_cor_merged<-merge(matriu_corr_sig,RNA_tab,by="row.names")


noms1<-RNA_tab$symbol[match(rownames(matriu_corr_sig),RNA_tab$Accession)]
noms1[is.na(noms1)]<-RNA_tab$Accession[match(rownames(matriu_corr_sig),RNA_tab$Accession)][is.na(noms1)]
rownames(matriu_corr_sig)<-noms1


p1<-pheatmap(matriu_corr_sig,
             show_rownames = T,
             cluster_rows =  T,
             cluster_cols =  F,
             fontsize_row = 3,
             name = "correlation",
             cutree_rows = 2,
             # cluster_rows =  T,cutree_cols = 2,
         # annotation_col = annotation_for_heatmap,
         # annotation_colors = ann_colors,
         # scale = "row",
         legend = F, 
         treeheight_row = 0,
         # legend_breaks = c(min(dists, na.rm = TRUE), 
         #                 max(dists, na.rm = TRUE)), 
         # legend_labels = (c("small distance", "large distance")),
         main = "Correalation miRNA with DE proteins")

p1

datatable_jm(matriu_cor_merged)

```

There are `r dim(matriu_corr_sig)[1]` proteins DE and correlated with at least one miRNA.

## Filter proteins correlated with all miRNAs


```{r}
matriu_corr_sig<-matriu_corr*(matriu_corr_p<=0.05)
matriu_filter<-matrix((apply(matriu_corr_sig, 1, function (x) sum(x!=0)>4))
                      ,dim(matriu_corr_sig)[1],1,dimnames = list(rownames(matriu_corr_sig),"boolean"))

matriu_corr_sig<-(matriu_corr_sig[matriu_filter,])
# Identificar proteines diferencialment expressades
matriu_corr_sig<-matriu_corr_sig[rownames(matriu_corr_sig)%in%rownames(RNA_tab_sig),]
matriu_cor_merged<-merge(matriu_corr_sig,RNA_tab,by="row.names")
noms1<-RNA_tab$symbol[match(rownames(matriu_corr_sig),RNA_tab$Accession)]
noms1[is.na(noms1)]<-RNA_tab$Accession[match(rownames(matriu_corr_sig),RNA_tab$Accession)][is.na(noms1)]
rownames(matriu_corr_sig)<-noms1


p1<-pheatmap(show_rownames = T,
             cluster_rows =  T,
             cluster_cols =  F,
             fontsize_row = 5,
             name = "correlation",
             matriu_corr_sig,
             cutree_rows = 2,
             # cluster_rows =  T,cutree_cols = 2,
         # annotation_col = annotation_for_heatmap,
         # annotation_colors = ann_colors,
         # scale = "row",
         legend = F, 
         treeheight_row = 0,
         # legend_breaks = c(min(dists, na.rm = TRUE), 
         #                 max(dists, na.rm = TRUE)), 
         # legend_labels = (c("small distance", "large distance")),
         main = "Correalation miRNA with DE proteins")

p1

datatable_jm(matriu_cor_merged)
```

There are `r dim(matriu_corr_sig)[1] ` proteins correlated with all miRNA.
